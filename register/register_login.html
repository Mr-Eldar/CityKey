<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/CityKey/register/css/main.css">
    <title>–ì–æ—Ä–æ–¥—Å–∫–æ–π –ö–ª—é—á</title>
</head>
<body>
    <main>
        <div class="form-container">
            <h2 id="form-title">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>

            <input type="text" id="name" placeholder="–ò–º—è">
            <input type="email" id="email" placeholder="–í–≤–µ–¥–∏—Ç–µ email">
            <input type="password" id="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
            <button id="submit-btn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>

                <button id="google-signin">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ <img src="/CityKey/register/google.webp" alt=""></button>

            <p id="toggle-form">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="#">–í–æ–π—Ç–∏</a></p>
        </div>
    </main>

    <script type="module">
        import { 
            initializeApp 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";

        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            onAuthStateChanged, 
            signOut, 
            updateProfile,
            signInWithPopup,
            GoogleAuthProvider
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        // üîπ Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const firebaseConfig = {
            apiKey: "AIzaSyC2ip3ZNS23CkckzbayIBUGzjzeV4ehngw",
            authDomain: "citykey-45fda.firebaseapp.com",
            projectId: "citykey-45fda",
            storageBucket: "citykey-45fda.firebasestorage.app",
            messagingSenderId: "339147353166",
            appId: "1:339147353166:web:5c83b83a5eaf11b9c6271f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // üîπ –≠–ª–µ–º–µ–Ω—Ç—ã —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        const formTitle = document.getElementById("form-title");
        const submitBtn = document.getElementById("submit-btn");
        const toggleForm = document.getElementById("toggle-form");
        const nameField = document.getElementById("name");
        const emailField = document.getElementById("email");
        const passwordField = document.getElementById("password");

        const accountSection = document.querySelector(".account");
        const userNameSpan = document.getElementById("user-name");
        const logoutBtn = document.getElementById("logout-btn");
        const googleSigninBtn = document.getElementById("google-signin");

        // üîπ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –≤—Ö–æ–¥
        submitBtn.addEventListener("click", async function () {
            const email = emailField.value;
            const password = passwordField.value;
            const name = nameField.value;

            if (formTitle.textContent === "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è") {
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;

                    // üîπ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    await updateProfile(user, { displayName: name });
                    await user.reload(); // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

                    alert("–ê–∫–∫–∞—É–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!");
                    window.location.href = "/CityKey/index.html"; // ‚úÖ –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –≥–ª–∞–≤–Ω—É—é
                } catch (error) {
                    alert("–û—à–∏–±–∫–∞: " + error.message);
                }
            } else {
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    window.location.href = "//CityKey/index.html"; // ‚úÖ –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –≥–ª–∞–≤–Ω—É—é
                } catch (error) {
                    console.log("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + error.message);
                }
            }
        });

        googleSigninBtn.addEventListener("click", async () => {
            try {
                const result = await signInWithPopup(auth, provider);
                // –í —Å–ª—É—á–∞–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—Ö–æ–¥–∞
                window.location.href = "/CityKey/index.html"; // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
            } catch (error) {
                console.log("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Google: " + error.message);
            }
        });

        // üîπ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã (–í—Ö–æ–¥/–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è)
        toggleForm.addEventListener("click", function (event) {
            event.preventDefault();
            if (formTitle.textContent === "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è") {
                switchToLogin();
            } else {
                switchToRegister();
            }
        });

        function switchToLogin() {
            formTitle.textContent = "–í—Ö–æ–¥";
            submitBtn.textContent = "–í–æ–π—Ç–∏";
            toggleForm.innerHTML = `–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="#">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>`;
            nameField.style.display = "none"; // ‚ùå –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–µ "–ò–º—è"
        }

        function switchToRegister() {
            formTitle.textContent = "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è";
            submitBtn.textContent = "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è";
            toggleForm.innerHTML = `–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="#">–í–æ–π—Ç–∏</a>`;
            nameField.style.display = "block"; // ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–µ "–ò–º—è"
        }
    </script>
</body>
</html>